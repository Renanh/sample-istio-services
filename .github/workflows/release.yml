name: Release

on:
  release:
    types: [published]

env:
  JAVA_VERSION: '21'
  REGISTRY: docker.io
  IMAGE_PREFIX: renanh

jobs:
  release:
    name: Release Docker Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [first-service, caller-service, callme-service]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push with Jib
        run: |
          mvn -B compile jib:build \
            -pl ${{ matrix.service }} -am \
            -Djib.to.image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }} \
            -Djib.to.tags=latest,${{ steps.version.outputs.VERSION }},${{ github.sha }}

  update-manifests:
    name: Update K8s Manifests
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update image tags in manifests
        run: |
          for service in first-service caller-service callme-service; do
            sed -i "s|image: ${{ env.IMAGE_PREFIX }}/${service}:.*|image: ${{ env.IMAGE_PREFIX }}/${service}:${{ steps.version.outputs.VERSION }}|g" ${service}/k8s/deployment.yaml
            sed -i "s|image: ${{ env.IMAGE_PREFIX }}/${service}:.*|image: ${{ env.IMAGE_PREFIX }}/${service}:${{ steps.version.outputs.VERSION }}|g" ${service}/k8s/deployment-versions.yaml
          done

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update image tags to ${{ steps.version.outputs.VERSION }}"
          branch: main
          file_pattern: '*/k8s/*.yaml'
